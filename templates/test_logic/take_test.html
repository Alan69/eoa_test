{% extends 'test_logic/test.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-4 order-lg-1"> <!-- Sidebar column -->
            <div class="card shadow mb-3">
                <div class="card-body" id="sidebar">
                    <!-- Question number buttons will be displayed here -->
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title">Таймер</h4>
                </div>
                <div class="card-body text-center">
                    <div id="timer">
                        <span id="minutes">45</span>:<span id="seconds">00</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8 order-lg-2"> <!-- Main content column -->
            <div class="card shadow mb-3">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">{{ test.title }}</h2>
                </div>
                <div class="card-body">
                    <div id="question-container">
                        <!-- The current question will be displayed here -->
                    </div>
                    <div class="text-center mt-3">
                        <button id="previous-question" class="btn btn-secondary mr-3" style="color: white;">Предыдущий вопрос</button>
                        <button id="next-question" class="btn btn-primary">Следующий вопрос</button>
                        <button id="submit-test" class="btn btn-success" style="display: none;">Завершить тест</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-lg-4 text-end">
            <button id="previous-test" class="btn btn-secondary mr-3" style="color: white;">Предыдущий тест</button>
        </div>
        <div class="col-lg-4 text-start">
            <button id="next-test" class="btn btn-primary">Следующий тест</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentQuestionIndex = 0;
        let questions = [];
        let responses = {};

        function loadQuestions() {
            fetch("{% url 'take_test' test.pk %}", {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                questions = data.questions;
                renderQuestion();
                renderSidebar();
            });
        }

        function renderQuestion() {
            const questionContainer = document.getElementById('question-container');
            questionContainer.innerHTML = '';

            if (currentQuestionIndex < 0 || currentQuestionIndex >= questions.length) {
                return;
            }

            const question = questions[currentQuestionIndex];
            const card = document.createElement('div');
            card.classList.add('card', 'mb-3');

            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body');

            const cardTitle = document.createElement('h5');
            cardTitle.classList.add('card-title');
            cardTitle.textContent = question.text;

            cardBody.appendChild(cardTitle);

            question.options.forEach(option => {
                const formCheck = document.createElement('div');
                formCheck.classList.add('form-check');

                const input = document.createElement('input');
                input.classList.add('form-check-input');
                input.type = 'radio';
                input.name = `question_${question.id}`;
                input.id = `option_${option.id}`;
                input.value = option.id;
                if (responses[question.id] === option.id.toString()) {
                    input.checked = true;
                }

                const label = document.createElement('label');
                label.classList.add('form-check-label');
                label.setAttribute('for', `option_${option.id}`);
                label.textContent = option.text;

                formCheck.appendChild(input);
                formCheck.appendChild(label);
                cardBody.appendChild(formCheck);
            });

            card.appendChild(cardBody);
            questionContainer.appendChild(card);

            updateNavigationButtons();
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';

            questions.forEach((question, index) => {
                const button = document.createElement('button');
                button.classList.add('btn', 'btn-secondary', 'mb-2');
                button.textContent = index + 1; // Question numbers start from 1

                button.addEventListener('click', function() {
                    currentQuestionIndex = index;
                    renderQuestion();
                    renderSidebar();
                });

                sidebar.appendChild(button);
            });

            // Highlight the selected button in the sidebar
            const currentButton = sidebar.querySelector(`button:nth-child(${currentQuestionIndex + 1})`);
            if (currentButton) {
                currentButton.classList.add('btn-success');
            }
        }

        function updateNavigationButtons() {
            const prevButton = document.getElementById('previous-question');
            const nextButton = document.getElementById('next-question');
            const prevTestButton = document.getElementById('previous-test');
            const nextTestButton = document.getElementById('next-test');
            const submitButton = document.getElementById('submit-test');

            prevButton.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
            nextButton.style.display = currentQuestionIndex < questions.length - 1 ? 'block' : 'none';
            submitButton.style.display = currentQuestionIndex === questions.length - 1 ? 'block' : 'none';

            // Handle previous test and next test buttons
            prevTestButton.style.display = 'block'; // Show previous test button
            nextTestButton.style.display = 'block'; // Show next test button

            // Add functionality to previous test button
            prevTestButton.addEventListener('click', function() {
                // Implement logic to navigate to previous test
                window.location.href = "{% url 'take_test' 1 %}";
                submitButton.style.display = 'none'; // Hide submit button when navigating to previous test
            });

            // Add functionality to next test button
            nextTestButton.addEventListener('click', function() {
                // Implement logic to navigate to next test
                window.location.href = "{% url 'take_test' 2 %}";
                submitButton.style.display = 'block'; // Show submit button when navigating to next test
            });
        }

        function saveResponse() {
            const selectedOption = document.querySelector(`input[name="question_${questions[currentQuestionIndex].id}"]:checked`);
            if (selectedOption) {
                responses[questions[currentQuestionIndex].id] = selectedOption.value;

                const formData = new FormData();
                formData.append(`question_id`, questions[currentQuestionIndex].id);
                formData.append(`question_${questions[currentQuestionIndex].id}`, selectedOption.value);

                return fetch("{% url 'take_test' test.pk %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => response.json());
            }
        }

        function nextQuestion() {
            saveResponse().then(data => {
                if (data && data.status === 'saved') {
                    currentQuestionIndex++;
                    renderQuestion();
                    renderSidebar();
                }
            });
        }

        function previousQuestion() {
            saveResponse().then(() => {
                currentQuestionIndex--;
                renderQuestion();
                renderSidebar();
            });
        }

        document.getElementById('next-question').addEventListener('click', nextQuestion);
        document.getElementById('previous-question').addEventListener('click', previousQuestion);

        document.getElementById('submit-test').addEventListener('click', function() {
            saveResponse().then(() => {
                const formData = new FormData();
                formData.append('submit', true);

                fetch("{% url 'take_test' test.pk %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(() => window.location.href = "{% url 'test_result' test.pk %}");
            });
        });

        // Timer
        let timerDuration = 45 * 60; // 45 minutes
        let minutesElement = document.getElementById('minutes');
        let secondsElement = document.getElementById('seconds');

        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutesElement.textContent = minutes < 10 ? "0" + minutes : minutes;
                secondsElement.textContent = seconds < 10 ? "0" + seconds : seconds;

                if (--timer < 0) {
                    // Handle timer end here if needed
                }
            }, 1000);
        }

        startTimer(timerDuration);

        loadQuestions();
    });
</script>
{% endblock %}
